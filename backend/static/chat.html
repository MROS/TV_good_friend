<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="/bower_components/bulma/css/bulma.min.css">
	<link rel="stylesheet" href="/css/chat.css">
</head>
<body>

	<header id="header" class="header">
		<div class="container">
			<!-- Left side -->
			<div class="header-left">
				<a class="header-item" href="#">
					<img src="/img/TV_logal.png" alt="Logo">
				</a>
			</div>
			<!-- Hamburger menu (on mobile) -->
			<span class="header-toggle">
				<span></span>
			</span>
			<!-- Right side -->
			<div class="header-right header-menu">
				<span class="header-item">
				</span>
			</div>
		</div>
	</header>


	<div id="main" class="columns">
		<div id="intro" class="column is-3">
			影片介紹
		</div>
		<div id="chat" class="column is-7">
			聊天區
			<div id="comment"></div>
			<div id="input-area">
				<p class="control is-grouped">
					<input id="talk" class="input" type="text" placeholder="說點什麼吧">
					<a class="button is-info">
						送出
					</a>
				</p>
				<div class="slideUp"><span>MROS: </span>hello</div>
			</div>
		</div>
		<div id="battle" class="column is-2">
			<div id="good" class="field">
				<img src="/img/good.png" alt="">
			</div>
			<div id="fuck" class="field">
				<img src="/img/fuck.png" alt="">
			</div>
		</div>
	</div>
	<script type="text/javascript">
		// init
		var good = 1.0, fuck = 1.0;
		var good_dom = document.getElementById("good");
		var fuck_dom = document.getElementById("fuck");
		good_dom.style.height = (good / (good + fuck) * 100) + "%";
		fuck_dom.style.height = (fuck / (good + fuck) * 100) + "%";

		// websocket 被動設定
		channel = window.location.href.split("/").slice(-1)[0]
		var socket = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/channel/" + channel.toString());
		var input_area = document.getElementById("input-area");
		socket.onmessage = function (e) {
			console.log(e.data);
			d = JSON.parse(e.data);
			switch (d.cmd) {
				case "comment":
					var comment = document.createElement("div");
					comment.innerHTML = "<span> "+ d.user  + " </span>: " + d.text;
					comment.className = "slideUp";
					input_area.appendChild(comment);
					break;
				case "emotion":
					if (d.type == "good") {
						good += 1;
					} else if (d.type == "fuck") {
						fuck += 1;
					}
					good_dom.style.height = (good / (good + fuck) * 100) + "%";
					fuck_dom.style.height = (fuck / (good + fuck) * 100) + "%";
					break;
			}
		}

		// 輸入彈幕
		var talk = document.getElementById("talk");
		talk.addEventListener("keypress", function(e) {
			if (e.keyCode == 13) {
				socket.send(JSON.stringify({cmd: "comment", user: "MROS", text: talk.value}))
				talk.value = ""
			}
		});

		// emotion
		good_dom.onclick = function () {
			socket.send(JSON.stringify({cmd: "emotion", type: "good"}));
		}
		fuck_dom.onclick = function () {
			socket.send(JSON.stringify({cmd: "emotion", type: "fuck"}));
		}
	</script>
</body>
</html>
